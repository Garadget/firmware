// $Id$
/**
 * @file door.cpp
 * @brief Garadget door class implementation
 * @author Denis Grisak
 * @version 1.9
 */
// $Log$

#include "webconfig.h"

const char s_configHtml[] = "<!DOCTYPE html><html><head><title>Soft AP configuration</title><meta name=viewport content='width=device-width'><link rel=stylesheet type=text/css href=config.css><script type=text/javascript src=config.js></script></head><body><div class=header><div class='header-content width-limit'><object type=image/svg+xml data=logo.svg></object><h1 id=title>Setup</h1></div></div><div class=top-anchor><div class=error-box id=error-box style=display:none></div><div class=message-box id=message-box style=display:none></div></div><form class='main width-limit' method=post><div class=settings-group><h2>Device</h2><div class=form-row><label>ID:</label><div class=input-action><input type=text name=id value='' disabled><object type=image/svg+xml data=copy.svg></object><div title='Copy Device ID' class=action-button onclick=f_copyId()></div></div></div><div class='form-row online-props'><label>Firmware:</label><input type=text name=ver value='' disabled></div></div><div class=settings-group><h2>WiFi</h2><div class=form-row><label>SSID:</label><div class=input-action><ul class=radio-group id=aplist onclick=f_apChange()><li>Loading...</li></ul><object type=image/svg+xml data=refresh.svg></object><div title='Rescan WiFi' class=action-button onclick=f_apScan()></div></div></div><div class=form-row id=box-ssid style=display:none><label>Hidden SSID:</label><input type=text name=ap-manual id=ssid-value value=''></div><div class='form-row online-props' id=box-pass style=display:none><label>Password:</label><div class=input-action><input type=password name=pass id=ap-pass value=''><object type=image/svg+xml data=show.svg></object><div title='Toggle Password Visibility' onclick=f_togglePass()></div></div></div></div><div class=settings-group><h2>MQTT</h2><div class=form-row><label>Mode:</label><ul class=radio-group><li><input type=radio name=mqtt value=mc><div>MQTT + Cloud</div></li><li><input type=radio name=mqtt value=m><div>Only MQTT</div></li><li><input type=radio name=mqtt value=c checked><div>Only Cloud</div></li></ul></div><div id=box-mqtt style=display:block><div class=form-row><label>Broker IP:</label><input type=text name=mqip value=''></div><div class='form-row online-props'><label>Broker Port:</label><input type=text name=mqpt value=1883></div><div class='form-row online-props'><label>Device Topic ID:</label><input type=text name=name value=garage><div class=row-note>Name uniquely identifying the device in MQTT topics e.g. /garadget/TOPIC_ID/open</div></div><div class=form-row><label>Reconnect Timeout:</label><select name=mqto></select><div class=row-note>Period to check the connection with server and reconnect if necessary</div></div></div></div><div class=settings-group><h2>Sensor</h2><div class=form-row><label>Scan Period:</label><select name=rdt></select><div class=row-note>Time between sensor scans</div></div><div class=form-row><label>Sensor Reads:</label><select name=srr></select><div class=row-note>Number of measurements in each period with results averaged</div></div><div class=form-row><label>Sensor Threshold:</label><select name=srt></select><div class=row-note>Lowest reflection reading to trigger the sensor</div></div></div><div class=settings-group><h2>Door</h2><div class=form-row><label>Door Motion Time:</label><select name=mtt></select><div class=row-note>Time it takes for door to completely open or close</div></div><div class=form-row><label>Relay On Time:</label><select name=rlt></select><div class=row-note>Duration of simulated button push</div></div><div class=form-row><label>Relay Off Time:</label><select name=rlp></select><div class=row-note>Time between consecutive button pushes</div></div></div></form><div class=footer><div class='footer-content width-limit'><button class='button-action button-passive' onclick=f_formSubmit()>Save &amp; Connect</button></div></div></body></html>";

const char s_configCss[] = "html{height:100%;margin:0}body{margin:0;text-align:center;font-family:Helvetica,sans-serif;font-size:16px}a,a:active,a:visited{text-decoration:none}.footer,.header{position:fixed;width:100%;background-color:#060;z-index:9}.header{top:0}.footer{bottom:0;text-align:right}.width-limit{max-width:600px;margin:0 auto;padding:10px 15px}.header object{height:50px;float:left}h1{color:#fff;font-weight:400;margin:0;font-size:30px;line-height:50px;text-transform:uppercase}.main{padding:100px 0}.top-anchor{position:relative}.top-anchor>div{position:absolute;width:100%;z-index:100;text-align:left}.error-box{background-color:#ffe0e0}.message-box{background-color:#e0ffe0}.top-anchor li{margin:10px 0;color:gray;font-size:16px;font-weight:700;line-height:20px}.settings-group{margin:10px 10px 20px 10px}.radio-group{list-style:none;margin:0 0;padding:5px 15px;border:1px solid silver}.radio-group li{margin:5px 0 5px 0;padding:0}.radio-group *{margin:0;padding:0;vertical-align:middle}.radio-group div{display:inline-block;margin-left:7px}.radio-group span{display:block;font-size:10px;color:grey}li.wifi-manual{margin-top:15px;font-style:italic}h2{text-align:left;margin:0 15px 10px 15px;border-bottom:4px solid silver}.form-row{max-width:300px;margin:0 auto 10px auto;text-align:left}.submit-row{max-width:300px;margin:20px auto}.submit-bar{padding:10px 0;text-align:right;flex-shrink:0}.form-row label{display:block;margin:0;color:gray}.form-row input[type=password],.form-row input[type=text],.form-row select{width:100%;padding:10px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;border:1px solid silver;font-size:16px}.input-action{position:relative}.action-button,.input-action object{position:absolute;max-height:40px;max-width:40px;overflow:auto;margin:auto 0 auto auto;top:0;left:0;bottom:0;right:0}.action-button{z-index:9;cursor:pointer}.row-note{font-size:10px;color:silver;margin-top:2px}.button-action{min-width:150px;color:#fff;border-left:0;border-top:0;border-right:0;font-weight:700;font-size:20px;padding:15px 20px;cursor:pointer;background-color:#f46809;border-bottom:2px solid #b24c07}.button-action:hover{background-color:#b24c07}.button-passive{background-color:grey;border-bottom:2px solid #606060;cursor:not-allowed}.button-passive:hover{background-color:grey}";

const char s_configJs[] = "function f_postRequest(e,s,n){var t=new XMLHttpRequest;t.open(\"POST\",s_baseUrl+e,!0),t.timeout=4e3,t.setRequestHeader(\"Content-Type\",\"multipart/form-data\"),t.send(JSON.stringify(s)),t.onreadystatechange=function(){4==t.readyState&&n&&(200==t.status?n.success&&n.success(JSON.parse(t.responseText)):n.error&&n.error(t.status,t.responseText),n.regardless&&n.regardless())}}function f_getRequest(e,s){if(-1==String(window.location).indexOf(\"192.168.0.1\"))return\"config\"==e&&s.success({id:\"330038000451353530353431\",ver:\"1.13\",mac:\"00:00:00:00:00:00\",ssid:\"TP-LINK\",rdt:1e3,mtt:1e4,rlt:300,rlp:1e3,srr:3,srt:15,nme:\"Garage\",mqon:255,mqip:\"255.255.255.255\",mqpt:65535,mqto:65535}),\"scan-ap\"==e&&s.success({scans:[{ssid:\"Huawei_HG532e_BF6A7\",rssi:-63,sec:4194310,ch:11,mdr:27e4},{ssid:\"PS4-60632F95A700\",rssi:-67,sec:4194308,ch:6,mdr:144400},{ssid:\"Bloomberg\",rssi:-62,sec:4194310,ch:8,mdr:27e4},{ssid:\"TP-LINK\",rssi:-65,sec:4194308,ch:3,mdr:3e5},{ssid:\"UKrtelecom_WPe7Eg\",rssi:-48,sec:4194308,ch:6,mdr:135e3},{ssid:\"EZCastmsy-4C3F0370\",rssi:-63,sec:4194308,ch:11,mdr:15e4}]}),void(s.regardless&&s.regardless());var n=new XMLHttpRequest;n.open(\"GET\",s_baseUrl+e,!0),n.timeout=8e3,n.send(),n.onreadystatechange=function(){4==n.readyState&&s&&(200==n.status?s.success&&s.success(JSON.parse(n.responseText)):s.error&&s.error(n.status,n.responseText),s.regardless&&s.regardless())}}function f_getById(e){return document.getElementById(e)}function f_inputValue(e,s){var n,t,r=document.forms[0].elements[e];if(r.options){if(n=r.options[r.selectedIndex].value,arguments.length>1)for(t=0;t<r.options.length;t++)if(r.options[t].value==s){r.selectedIndex=t;break}}else\"checkbox\"==r.type&&(n=!!r.checked&&r.value,r.checked=s);return void 0!=r.value&&(n=r.value,arguments.length>1&&(r.value=s)),n}function f_populateSelect(e,s,n,t){var r=document.forms[0].elements[e];r.options.length=0;for(var o,a=!1,i=0;i<s.length;i+=2)o=s[i+1],r.options[r.options.length]=new Option(s[i],o),arguments.length>3&&o==t&&(r.selectedIndex=i/2,a=!0);!a&&arguments.length>2&&f_inputValue(e,n)}function f_validate(e,s){document.forms[0].elements[e].onkeydown=s}function f_signalStrength(e){var s;return s=e<=-85?\"poor\":e<=-60?\"good\":\"excellent\",e+\"dB (\"+s+\")\"}function f_copyId(){window.prompt(\"Copy to clipboard: Ctrl + C, Enter\",f_inputValue(\"id\"))}function f_apScan(){var e=\"\",s=f_getById(\"aplist\");s.innerHTML=\"<li>Loading...</li>\",f_getRequest(\"scan-ap\",{success:function(s){var n,t={0:\"Not Secured\",1:\"WEP pre-shared key\",32769:\"Open WEP\",2097154:\"WPA with TKIP\",2097156:\"WPA with AES\",4194308:\"WPA2 with TKIP\",4194306:\"WPA2 with AES\",4194310:\"WPA2 AES & TKIP\"},r=s.scans;for(n=0;n<r.length;n++)r[n].value=n;for(r.sort(function(e,s){return s.rssi-e.rssi}),n=0;n<r.length;n++){var o=r[n];e+='<li><input type=\"radio\" name=\"ap\" value=\"'+o.value+'\"'+(window.s_ssid==o.ssid?\"checked\":\"\")+\" /><div>\"+o.ssid+\"<span>\"+(t[o.sec]?t[o.sec]+\", \":\"\")+f_signalStrength(o.rssi)+\"</span></div></li>\"}n||(e+=\"<li>No networks found</li>\")},error:function(){e+='<li style=\"color:red\">Error Scanning Networks</li>'},regardless:function(){e+='<li><input type=\"radio\" name=\"ap\" value=\"-\" /><div>Enter Manually<span>Use For Hidden Networks</span></div></li>',s.innerHTML=e,f_apChange()}})}function f_apChange(){var e=f_inputValue(\"ap\");f_getById(\"box-pass\").style.display=\"block\",console.log(e)}var s_baseUrl=\"http://192.168.0.1/\";window.onload=function(){f_validate(\"mqip\",function(e){for(var s=this.value.split(\".\"),n=0;n<4;n++){if(!isNaN(s[n])){s[n]=\"\";break}s[n]=Math.abs(parseInt(s[n]))}return this.value=s.join(\".\"),!0}),f_getRequest(\"config\",{success:function(e){f_inputValue(\"id\",e.id),f_inputValue(\"ver\",e.ver),f_inputValue(\"mqip\",e.mqip),f_populateSelect(\"mqto\",[\"1 second\",1e3,\"2 seconds\",2e3,\"3 seconds\",3e3,\"5 seconds\",5e3,\"10 seconds\",1e4,\"30 seconds\",3e4,\"1 minute\",6e4,\"5 minutes\",3e5],5e3,e.mqto),f_populateSelect(\"rdt\",[\"twice per second\",500,\"every second\",1e3,\"every 2 seconds\",2e3,\"every 3 seconds\",3e3,\"every 5 seconds\",5e3,\"every 10 seconds\",1e4,\"twice per minute\",3e4,\"every minute\",6e4],1e3,e.rdt),f_populateSelect(\"srr\",[1,1,2,2,3,3,4,4,5,5],3,e.srr);var s=[\"3%\",3];for(n_value=5;n_value<=80;n_value+=5)s[s.length]=n_value+\"%\",s[s.length]=n_value;for(f_populateSelect(\"srt\",s,15,e.srt),s=[],n_value=5;n_value<=30;n_value++)s[s.length]=n_value+\" seconds\",s[s.length]=1e3*n_value;for(f_populateSelect(\"mtt\",s,1e4,e.mtt),f_populateSelect(\"rlt\",[\"0.2 second\",200,\"0.3 second\",300,\"0.4 second\",400,\"0.5 second\",500,\"0.7 second\",700,\"1 second\",1e3],e.rlt),s=[],n_value=300;n_value<=1e3;n_value+=100)s[s.length]=n_value/1e3+\" second\",s[s.length]=n_value;for(n_value=2;n_value<=5;n_value+=1)s[s.length]=n_value+\" seconds\",s[s.length]=1e3*n_value;f_populateSelect(\"rlp\",s,[],e.rlp),window.s_ssid=e.ssid,f_apScan()}})};";

const char index_html[] = "<!DOCTYPE html><html><head><meta name='viewport' content='width=device-width, initial-scale=1'><title>Setup your device</title><link rel='stylesheet' type='text/css' href='style.css'></head><body>"
"<h1>Connect me to your WiFi!</h1><h3>My device ID:</h3><input type=text id='device-id' size='25' value='' disabled/><button type='button' class='input-helper' id='copy-button'>Copy</button><div id='scan-div'><h3>Scan for visible WiFi networks</h3><button id='scan-button' type='button'>Scan</button></div><div id='networks-div'></div><div id='connect-div' style='display: none'><p>Don't see your network? Move me closer to your router, then re-scan.</p><form id='connect-form'><input type='password' id='password' size='25' placeholder='password'/><button type='button' class='input-helper' id='show-button'>Show</button><button type='submit' id='connect-button'>Connect</button></form></div><script src='rsa-utils/jsbn_1.js'></script><script src='rsa-utils/jsbn_2.js'></script><script src='rsa-utils/prng4.js'></script><script src='rsa-utils/rng.js'></script><script src='rsa-utils/rsa.js'></script><script src='script.js'></script></body></html>";

const char rsa_js[] = "function parseBigInt(a,b){return new BigInteger(a,b);}function linebrk(a,b){var c='';var d=0;while(d+b<a.length){c+=a.substring(d,d+b)+'\\n';d+=b;}return c+a.substring(d,a.length);}function byte2Hex(a){if(a<0x10)return '0'+a.toString(16);else return a.toString(16);}function pkcs1pad2(a,b){if(b<a.length+11){alert('Message too long for RSA');return null;}var c=new Array();var d=a.length-1;while(d>=0&&b>0){var e=a.charCodeAt(d--);if(e<128)c[--b]=e;else if((e>127)&&(e<2048)){c[--b]=(e&63)|128;c[--b]=(e>>6)|192;}else{c[--b]=(e&63)|128;c[--b]=((e>>6)&63)|128;c[--b]=(e>>12)|224;}}c[--b]=0;var f=new SecureRandom();var g=new Array();while(b>2){g[0]=0;while(g[0]==0)f.nextBytes(g);c[--b]=g[0];}c[--b]=2;c[--b]=0;return new BigInteger(c);}function RSAKey(){this.n=null;this.e=0;this.d=null;this.p=null;this.q=null;this.dmp1=null;this.dmq1=null;this.coeff=null;}function RSASetPublic(a,b){if(a!=null&&b!=null&&a.length>0&&b.length>0){this.n=parseBigInt(a,16);this.e=parseInt(b,16);}else alert('Invalid RSA public key');}function RSADoPublic(a){return a.modPowInt(this.e,this.n);}function RSAEncrypt(a){var b=pkcs1pad2(a,(this.n.bitLength()+7)>>3);if(b==null)return null;var c=this.doPublic(b);if(c==null)return null;var d=c.toString(16);if((d.length&1)==0)return d;else return '0'+d;}RSAKey.prototype.doPublic=RSADoPublic;RSAKey.prototype.setPublic=RSASetPublic;RSAKey.prototype.encrypt=RSAEncrypt;";

const char style_css[] = "html{height:100%;margin:auto;background-color:white}body{box-sizing:border-box;min-height:100%;padding:20px;background-color:#1aabe0;font-family:'Lucida Sans Unicode','Lucida Grande',sans-serif;font-weight:normal;color:white;margin-top:0;margin-left:auto;margin-right:auto;margin-bottom:0;max-width:400px;text-align:center;border:1px solid #6e6e70;border-radius:4px}div{margin-top:25px;margin-bottom:25px}h1{margin-top:25px;margin-bottom:25px}button{border-color:#1c75be;background-color:#1c75be;color:white;border-radius:5px;height:30px;font-size:15px;font-weight:bold}button.input-helper{background-color:#bebebe;border-color:#bebebe;color:#6e6e70;margin-left:3px}button:disabled{background-color:#bebebe;border-color:#bebebe;color:white}input[type='text'],input[type='password']{background-color:white;color:#6e6e70;border-color:white;border-radius:5px;height:25px;text-align:center;font-size:15px}input:disabled{background-color:#bebebe;border-color:#bebebe}input[type='radio']{position:relative;bottom:-0.33em;margin:0;border:0;height:1.5em;width:15%}label{padding-top:7px;padding-bottom:7px;padding-left:5%;display:inline-block;width:80%;text-align:left}input[type='radio']:checked+label{font-weight:bold;color:#1c75be}.scanning-error{font-weight:bold;text-align:center}.radio-div{box-sizing:border-box;margin:2px;margin-left:auto;margin-right:auto;background-color:white;color:#6e6e70;border:1px solid #6e6e70;border-radius:3px;width:100%;padding:5px}#networks-div{margin-left:auto;margin-right:auto;text-align:left}#device-id{text-align:center}#scan-button{min-width:100px}#connect-button{display:block;min-width:100px;margin-top:10px;margin-left:auto;margin-right:auto;margin-bottom:20px}#password{margin-top:20px;margin-bottom:10px}";

const char rng_js[] = "var rng_state;var rng_pool;var rng_pptr;function rng_seed_int(a){rng_pool[rng_pptr++]^=a&255;rng_pool[rng_pptr++]^=(a>>8)&255;rng_pool[rng_pptr++]^=(a>>16)&255;rng_pool[rng_pptr++]^=(a>>24)&255;if(rng_pptr>=rng_psize)rng_pptr-=rng_psize;}function rng_seed_time(){rng_seed_int(new Date().getTime());}if(rng_pool==null){rng_pool=new Array();rng_pptr=0;var t;if(window.crypto&&window.crypto.getRandomValues){var ua=new Uint8Array(32);window.crypto.getRandomValues(ua);for(t=0;t<32;++t)rng_pool[rng_pptr++]=ua[t];}if(navigator.appName=='Netscape'&&navigator.appVersion<'5'&&window.crypto){var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=z.charCodeAt(t)&255;}while(rng_pptr<rng_psize){t=Math.floor(65536*Math.random());rng_pool[rng_pptr++]=t>>>8;rng_pool[rng_pptr++]=t&255;}rng_pptr=0;rng_seed_time();}function rng_get_byte(){if(rng_state==null){rng_seed_time();rng_state=prng_newstate();rng_state.init(rng_pool);for(rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0;}return rng_state.next();}function rng_get_bytes(a){var b;for(b=0;b<a.length;++b)a[b]=rng_get_byte();}function SecureRandom(){}SecureRandom.prototype.nextBytes=rng_get_bytes;";

const char jsbn_2_js[] = "function bnpRShiftTo(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t){b.t=0;return;}var d=a%this.DB;var e=this.DB-d;var f=(1<<d)-1;b[0]=this[c]>>d;for(var g=c+1;g<this.t;++g){b[g-c-1]|=(this[g]&f)<<e;b[g-c]=this[g]>>d;}if(d>0)b[this.t-c-1]|=(this.s&f)<<e;b.t=this.t-c;b.clamp();}function bnpSubTo(a,b){var c=0,d=0,e=Math.min(a.t,this.t);while(c<e){d+=this[c]-a[c];b[c++]=d&this.DM;d>>=this.DB;}if(a.t<this.t){d-=a.s;while(c<this.t){d+=this[c];b[c++]=d&this.DM;d>>=this.DB;}d+=this.s;}else{d+=this.s;while(c<a.t){d-=a[c];b[c++]=d&this.DM;d>>=this.DB;}d-=a.s;}b.s=(d<0)?-1:0;if(d<-1)b[c++]=this.DV+d;else if(d>0)b[c++]=d;b.t=c;b.clamp();}function bnpMultiplyTo(a,b){var c=this.abs(),d=a.abs();var e=c.t;b.t=e+d.t;while(--e>=0)b[e]=0;for(e=0;e<d.t;++e)b[e+c.t]=c.am(0,d[e],b,e,0,c.t);b.s=0;b.clamp();if(this.s!=a.s)BigInteger.ZERO.subTo(b,b);}function bnpSquareTo(a){var b=this.abs();var c=a.t=2*b.t;while(--c>=0)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);if((a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV){a[c+b.t]-=b.DV;a[c+b.t+1]=1;}}if(a.t>0)a[a.t-1]+=b.am(c,b[c],a,2*c,0,1);a.s=0;a.clamp();}function bnpDivRemTo(a,b,c){var d=a.abs();if(d.t<=0)return;var e=this.abs();if(e.t<d.t){if(b!=null)b.fromInt(0);if(c!=null)this.copyTo(c);return;}if(c==null)c=nbi();var f=nbi(),g=this.s,h=a.s;var i=this.DB-nbits(d[d.t-1]);if(i>0){d.lShiftTo(i,f);e.lShiftTo(i,c);}else{d.copyTo(f);e.copyTo(c);}var j=f.t;var k=f[j-1];if(k==0)return;var l=k*(1<<this.F1)+((j>1)?f[j-2]>>this.F2:0);var m=this.FV/l,n=(1<<this.F1)/l,o=1<<this.F2;var p=c.t,q=p-j,r=(b==null)?nbi():b;f.dlShiftTo(q,r);if(c.compareTo(r)>=0){c[c.t++]=1;c.subTo(r,c);}BigInteger.ONE.dlShiftTo(j,r);r.subTo(f,f);while(f.t<j)f[f.t++]=0;while(--q>=0){var s=(c[--p]==k)?this.DM:Math.floor(c[p]*m+(c[p-1]+o)*n);if((c[p]+=f.am(0,s,c,q,0,j))<s){f.dlShiftTo(q,r);c.subTo(r,c);while(c[p]<--s)c.subTo(r,c);}}if(b!=null){c.drShiftTo(j,b);if(g!=h)BigInteger.ZERO.subTo(b,b);}c.t=j;c.clamp();if(i>0)c.rShiftTo(i,c);if(g<0)BigInteger.ZERO.subTo(c,c);}function bnMod(a){var b=nbi();this.abs().divRemTo(a,null,b);if(this.s<0&&b.compareTo(BigInteger.ZERO)>0)a.subTo(b,b);return b;}function Classic(a){this.m=a;}function cConvert(a){if(a.s<0||a.compareTo(this.m)>=0)return a.mod(this.m);else return a;}function cRevert(a){return a;}function cReduce(a){a.divRemTo(this.m,null,a);}function cMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c);}function cSqrTo(a,b){a.squareTo(b);this.reduce(b);}Classic.prototype.convert=cConvert;Classic.prototype.revert=cRevert;Classic.prototype.reduce=cReduce;Classic.prototype.mulTo=cMulTo;Classic.prototype.sqrTo=cSqrTo;function bnpInvDigit(){if(this.t<1)return 0;var a=this[0];if((a&1)==0)return 0;var b=a&3;b=(b*(2-(a&0xf)*b))&0xf;b=(b*(2-(a&0xff)*b))&0xff;b=(b*(2-(((a&0xffff)*b)&0xffff)))&0xffff;b=(b*(2-a*b%this.DV))%this.DV;return(b>0)?this.DV-b:-b;}function Montgomery(a){this.m=a;this.mp=a.invDigit();this.mpl=this.mp&0x7fff;this.mph=this.mp>>15;this.um=(1<<(a.DB-15))-1;this.mt2=2*a.t;}function montConvert(a){var b=nbi();a.abs().dlShiftTo(this.m.t,b);b.divRemTo(this.m,null,b);if(a.s<0&&b.compareTo(BigInteger.ZERO)>0)this.m.subTo(b,b);return b;}function montRevert(a){var b=nbi();a.copyTo(b);this.reduce(b);return b;}function montReduce(a){while(a.t<=this.mt2)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=a[b]&0x7fff;var d=(c*this.mpl+(((c*this.mph+(a[b]>>15)*this.mpl)&this.um)<<15))&a.DM;c=b+this.m.t;a[c]+=this.m.am(0,d,a,b,0,this.m.t);while(a[c]>=a.DV){a[c]-=a.DV;a[++c]++;}}a.clamp();a.drShiftTo(this.m.t,a);if(a.compareTo(this.m)>=0)a.subTo(this.m,a);}function montSqrTo(a,b){a.squareTo(b);this.reduce(b);}function montMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c);}Montgomery.prototype.convert=montConvert;Montgomery.prototype.revert=montRevert;Montgomery.prototype.reduce=montReduce;Montgomery.prototype.mulTo=montMulTo;Montgomery.prototype.sqrTo=montSqrTo;function bnpIsEven(){return((this.t>0)?(this[0]&1):this.s)==0;}function bnpExp(a,b){if(a>0xffffffff||a<1)return BigInteger.ONE;var c=nbi(),d=nbi(),e=b.convert(this),f=nbits(a)-1;e.copyTo(c);while(--f>=0){b.sqrTo(c,d);if((a&(1<<f))>0)b.mulTo(d,e,c);else{var g=c;c=d;d=g;}}return b.revert(c);}function bnModPowInt(a,b){var c;if(a<256||b.isEven())c=new Classic(b);else c=new Montgomery(b);return this.exp(a,c);}BigInteger.prototype.copyTo=bnpCopyTo;BigInteger.prototype.fromInt=bnpFromInt;BigInteger.prototype.fromString=bnpFromString;BigInteger.prototype.clamp=bnpClamp;BigInteger.prototype.dlShiftTo=bnpDLShiftTo;BigInteger.prototype.drShiftTo=bnpDRShiftTo;BigInteger.prototype.lShiftTo=bnpLShiftTo;BigInteger.prototype.rShiftTo=bnpRShiftTo;BigInteger.prototype.subTo=bnpSubTo;BigInteger.prototype.multiplyTo=bnpMultiplyTo;BigInteger.prototype.squareTo=bnpSquareTo;BigInteger.prototype.divRemTo=bnpDivRemTo;BigInteger.prototype.invDigit=bnpInvDigit;BigInteger.prototype.isEven=bnpIsEven;BigInteger.prototype.exp=bnpExp;BigInteger.prototype.toString=bnToString;BigInteger.prototype.negate=bnNegate;BigInteger.prototype.abs=bnAbs;BigInteger.prototype.compareTo=bnCompareTo;BigInteger.prototype.bitLength=bnBitLength;BigInteger.prototype.mod=bnMod;BigInteger.prototype.modPowInt=bnModPowInt;BigInteger.ZERO=nbv(0);BigInteger.ONE=nbv(1);";

const char jsbn_1_js[] = "var dbits;var canary=0xdeadbeefcafe;var j_lm=((canary&0xffffff)==0xefcafe);function BigInteger(a,b,c){if(a!=null)if('number'==typeof a)this.fromNumber(a,b,c);else if(b==null&&'string'!=typeof a)this.fromString(a,256);else this.fromString(a,b);}function nbi(){return new BigInteger(null);}function am1(a,b,c,d,e,f){while(--f>=0){var g=b*this[a++]+c[d]+e;e=Math.floor(g/0x4000000);c[d++]=g&0x3ffffff;}return e;}function am2(a,b,c,d,e,f){var g=b&0x7fff,h=b>>15;while(--f>=0){var i=this[a]&0x7fff;var j=this[a++]>>15;var k=h*i+j*g;i=g*i+((k&0x7fff)<<15)+c[d]+(e&0x3fffffff);e=(i>>>30)+(k>>>15)+h*j+(e>>>30);c[d++]=i&0x3fffffff;}return e;}function am3(a,b,c,d,e,f){var g=b&0x3fff,h=b>>14;while(--f>=0){var i=this[a]&0x3fff;var j=this[a++]>>14;var k=h*i+j*g;i=g*i+((k&0x3fff)<<14)+c[d]+e;e=(i>>28)+(k>>14)+h*j;c[d++]=i&0xfffffff;}return e;}if(j_lm&&(navigator.appName=='Microsoft Internet Explorer')){BigInteger.prototype.am=am2;dbits=30;}else if(j_lm&&(navigator.appName!='Netscape')){BigInteger.prototype.am=am1;dbits=26;}else{BigInteger.prototype.am=am3;dbits=28;}BigInteger.prototype.DB=dbits;BigInteger.prototype.DM=((1<<dbits)-1);BigInteger.prototype.DV=(1<<dbits);var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP);BigInteger.prototype.F1=BI_FP-dbits;BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM='0123456789abcdefghijklmnopqrstuvwxyz';var BI_RC=new Array();var rr,vv;rr='0'.charCodeAt(0);for(vv=0;vv<=9;++vv)BI_RC[rr++]=vv;rr='a'.charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;rr='A'.charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(a){return BI_RM.charAt(a);}function intAt(a,b){var c=BI_RC[a.charCodeAt(b)];return(c==null)?-1:c;}function bnpCopyTo(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t;a.s=this.s;}function bnpFromInt(a){this.t=1;this.s=(a<0)?-1:0;if(a>0)this[0]=a;else if(a<-1)this[0]=a+this.DV;else this.t=0;}function nbv(a){var b=nbi();b.fromInt(a);return b;}function bnpFromString(a,b){var c;if(b==16)c=4;else if(b==8)c=3;else if(b==256)c=8;else if(b==2)c=1;else if(b==32)c=5;else if(b==4)c=2;else{this.fromRadix(a,b);return;}this.t=0;this.s=0;var d=a.length,e=false,f=0;while(--d>=0){var g=(c==8)?a[d]&0xff:intAt(a,d);if(g<0){if(a.charAt(d)=='-')e=true;continue;}e=false;if(f==0)this[this.t++]=g;else if(f+c>this.DB){this[this.t-1]|=(g&((1<<(this.DB-f))-1))<<f;this[this.t++]=(g>>(this.DB-f));}else this[this.t-1]|=g<<f;f+=c;if(f>=this.DB)f-=this.DB;}if(c==8&&(a[0]&0x80)!=0){this.s=-1;if(f>0)this[this.t-1]|=((1<<(this.DB-f))-1)<<f;}this.clamp();if(e)BigInteger.ZERO.subTo(this,this);}function bnpClamp(){var a=this.s&this.DM;while(this.t>0&&this[this.t-1]==a)--this.t;}function bnToString(a){if(this.s<0)return '-'+this.negate().toString(a);var b;if(a==16)b=4;else if(a==8)b=3;else if(a==2)b=1;else if(a==32)b=5;else if(a==4)b=2;else return this.toRadix(a);var c=(1<<b)-1,d,e=false,f='',g=this.t;var h=this.DB-(g*this.DB)%b;if(g-->0){if(h<this.DB&&(d=this[g]>>h)>0){e=true;f=int2char(d);}while(g>=0){if(h<b){d=(this[g]&((1<<h)-1))<<(b-h);d|=this[--g]>>(h+=this.DB-b);}else{d=(this[g]>>(h-=b))&c;if(h<=0){h+=this.DB;--g;}}if(d>0)e=true;if(e)f+=int2char(d);}}return e?f:'0';}function bnNegate(){var a=nbi();BigInteger.ZERO.subTo(this,a);return a;}function bnAbs(){return(this.s<0)?this.negate():this;}function bnCompareTo(a){var b=this.s-a.s;if(b!=0)return b;var c=this.t;b=c-a.t;if(b!=0)return(this.s<0)?-b:b;while(--c>=0)if((b=this[c]-a[c])!=0)return b;return 0;}function nbits(a){var b=1,c;if((c=a>>>16)!=0){a=c;b+=16;}if((c=a>>8)!=0){a=c;b+=8;}if((c=a>>4)!=0){a=c;b+=4;}if((c=a>>2)!=0){a=c;b+=2;}if((c=a>>1)!=0){a=c;b+=1;}return b;}function bnBitLength(){if(this.t<=0)return 0;return this.DB*(this.t-1)+nbits(this[this.t-1]^(this.s&this.DM));}function bnpDLShiftTo(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a;b.s=this.s;}function bnpDRShiftTo(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0);b.s=this.s;}function bnpLShiftTo(a,b){var c=a%this.DB;var d=this.DB-c;var e=(1<<d)-1;var f=Math.floor(a/this.DB),g=(this.s<<c)&this.DM,h;for(h=this.t-1;h>=0;--h){b[h+f+1]=(this[h]>>d)|g;g=(this[h]&e)<<c;}for(h=f-1;h>=0;--h)b[h]=0;b[f]=g;b.t=this.t+f+1;b.s=this.s;b.clamp();}";

const char script_js[] = "var base_url='http://192.168.0.1/';var network_list;var public_key;var rsa=new RSAKey();var scanButton=document.getElementById('scan-button');var connectButton=document.getElementById('connect-button');var copyButton=document.getElementById('copy-button');var showButton=document.getElementById('show-button');var deviceID=document.getElementById('device-id');var connectForm=document.getElementById('connect-form');var public_key_callback={success:function(a){console.log('Public key: '+a.b);public_key=a.b;rsa.setPublic(public_key.substring(58,58+256),public_key.substring(318,318+6));},error:function(a,b){console.log(a);window.alert('There was a problem fetching important information from your device. Please verify your connection, then reload this page.');}};var device_id_callback={success:function(a){var b=a.id;deviceID.value=b;},error:function(a,b){console.log(a);var c='COMMUNICATION_ERROR';deviceID.value=c;}};var scan=function(){console.log('Scanning...!');disableButtons();scanButton.innerHTML='Scanning...';connectButton.innerHTML='Connect';document.getElementById('connect-div').style.display='none';document.getElementById('networks-div').style.display='none';getRequest(base_url+'scan-ap',scan_callback);};var scan_callback={success:function(a){network_list=a.scans;console.log('I found:');var b=document.getElementById('networks-div');b.innerHTML='';if(network_list.length>0)for(var c=0;c<network_list.length;c++){ssid=network_list[c].ssid;console.log(network_list[c]);add_wifi_option(b,ssid);document.getElementById('connect-div').style.display='block';}else b.innerHTML='<p class=\\'scanning-error\\'>No networks found.</p>';},error:function(a){console.log('Scanning error:'+a);document.getElementById('networks-div').innerHTML='<p class=\\'scanning-error\\'>Scanning error.</p>';},regardless:function(){scanButton.innerHTML='Re-Scan';enableButtons();document.getElementById('networks-div').style.display='block';}};var configure=function(a){a.preventDefault();var b=get_selected_network();var c=document.getElementById('password').value;if(!b){window.alert('Please select a network!');return false;}var d={idx:0,ssid:b.ssid,pwd:rsa.encrypt(c),sec:b.sec,ch:b.ch};connectButton.innerHTML='Sending credentials...';disableButtons();console.log('Sending credentials: '+JSON.stringify(d));postRequest(base_url+'configure-ap',d,configure_callback);};var configure_callback={success:function(a){console.log('Credentials received.');connectButton.innerHTML='Credentials received...';postRequest(base_url+'connect-ap',{idx:0},connect_callback);},error:function(a,b){console.log('Configure error: '+a);window.alert('The configuration command failed, check that you are still well connected to the device\\'s WiFi hotspot and retry.');connectButton.innerHTML='Retry';enableButtons();}};var connect_callback={success:function(a){console.log('Attempting to connect to the cloud.');connectButton.innerHTML='Attempting to connect...';window.alert('Your device should now start flashing green and attempt to connect to the cloud. This usually takes about 20 seconds, after which it will begin slowly blinking cyan. \\n\\n\\nIf this process fails because you entered the wrong password, the device will flash green indefinitely. In this case, hold the setup button for 6 seconds until the device starts blinking blue again. Then reconnect to the WiFi hotspot it generates and reload this page to try again.');},error:function(a,b){console.log('Connect error: '+a);window.alert('The connect command failed, check that you are still well connected to the device\\'s WiFi hotspot and retry.');connectButton.innerHTML='Retry';enableButtons();}};var disableButtons=function(){connectButton.disabled=true;scanButton.disabled=true;};var enableButtons=function(){connectButton.disabled=false;scanButton.disabled=false;};var add_wifi_option=function(a,b){var c=document.createElement('INPUT');c.type='radio';c.value=b;c.id=b;c.name='ssid';c.className='radio';var d=document.createElement('DIV');d.className='radio-div';d.appendChild(c);var e=document.createElement('label');e.htmlFor=b;e.innerHTML=b;d.appendChild(e);a.appendChild(d);};var get_selected_network=function(){for(var a=0;a<network_list.length;a++){ssid=network_list[a].ssid;if(document.getElementById(ssid).checked)return network_list[a];}};var copy=function(){window.prompt('Copy to clipboard: Ctrl + C, Enter',deviceID.value);};var toggleShow=function(){var a=document.getElementById('password');inputType=a.type;if(inputType==='password'){showButton.innerHTML='Hide';a.type='text';}else{showButton.innerHTML='Show';a.type='password';}};var getRequest=function(a,b){var c=new XMLHttpRequest();c.open('GET',a,true);c.timeout=8000;c.send();c.onreadystatechange=function(){if(c.readyState==4)if(b){if(c.status==200){if(b.success)b.success(JSON.parse(c.responseText));}else if(b.error)b.error(c.status,c.responseText);if(b.regardless)b.regardless();}};};var postRequest=function(a,b,c){var d=JSON.stringify(b);var e=new XMLHttpRequest();e.open('POST',a,true);e.timeout=4000;e.setRequestHeader('Content-Type','multipart/form-data');e.send(d);e.onreadystatechange=function(){if(e.readyState==4)if(c){if(e.status==200){if(c.success)c.success(JSON.parse(e.responseText));}else if(c.error)c.error(e.status,e.responseText);if(c.regardless)c.regardless();}};};if(scanButton.addEventListener){copyButton.addEventListener('click',copy);showButton.addEventListener('click',toggleShow);scanButton.addEventListener('click',scan);connectForm.addEventListener('submit',configure);}else if(scanButton.attachEvent){copyButton.attachEvent('onclick',copy);showButton.attachEvent('onclick',toggleShow);scanButton.attachEvent('onclick',scan);connectForm.attachEvent('onsubmit',configure);}getRequest(base_url+'device-id',device_id_callback);getRequest(base_url+'public-key',public_key_callback);";

const char prng4_js[] = "function Arcfour(){this.i=0;this.j=0;this.S=new Array();}function ARC4init(a){var b,c,d;for(b=0;b<256;++b)this.S[b]=b;c=0;for(b=0;b<256;++b){c=(c+this.S[b]+a[b%a.length])&255;d=this.S[b];this.S[b]=this.S[c];this.S[c]=d;}this.i=0;this.j=0;}function ARC4next(){var a;this.i=(this.i+1)&255;this.j=(this.j+this.S[this.i])&255;a=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=a;return this.S[(a+this.S[this.i])&255];}Arcfour.prototype.init=ARC4init;Arcfour.prototype.next=ARC4next;function prng_newstate(){return new Arcfour();}var rng_psize=256;";

const char s_logoSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"0 0 100 100\">\n"
  "<style type=\"text/css\">path{fill:white}</style>\n"
  "<path d=\"M57.3,69.7c-4.6,0.6-9.1-0.7-12.8-3.4l-24.1,2.7v10.5l64.1-10v-7.8l-15.9,1.8C65.6,66.9,61.7,69.1,57.3,69.7z\"/>\n"
  "<path d=\"M35.4,52.1l-15,0.7V63l19.2-1.7C37.7,58.7,36.3,55.5,35.4,52.1z\"/>\n"
  "<path d=\"M44.3,22.7l-23.9-1.9v10.7l16.7,0.6C38.8,28.2,41.3,25,44.3,22.7z\"/>\n"
  "<path d=\"M72.4,58.4l12.1-1.1v-7.6l-9.2,0.4C74.8,53.1,73.8,55.9,72.4,58.4z\"/>\n"
  "<path d=\"M34.5,44.6c0-2.4,0.3-4.7,0.7-6.9l-14.8-0.2v9.3l14.2-0.3C34.5,45.8,34.5,45.2,34.5,44.6z\"/>\n"
  "<path d=\"M57.3,55.4c-8.5,0.6-16-7.8-16-18.8c0-0.7,0-1.3,0.1-2c-1.2,2.9-1.9,6.2-1.9,9.7c0,12.1,8.4,21.2,17.8,20.2c8.9-1,15.3-10.3,15.3-20.7c0-2.9-0.5-5.6-1.4-8.2c0,0.5,0,1,0,1.5C71.2,46.7,65.3,54.9,57.3,55.4z\"/>\n"
  "<path d=\"M47.4,30.2c-0.9,1.9-1.4,4.1-1.4,6.5c0,7.8,5.3,13.8,11.3,13.5c5.9-0.3,10.2-6.2,10.2-13.1c0-2.1-0.4-4.2-1.1-6c-0.2,6-4,10.9-9.1,11C52.1,42.1,47.5,36.9,47.4,30.2z\"/>\n"
  "<path d=\"M76,43.9c0,0.5,0,1,0,1.5l8.6-0.2v-6.9l-9.1-0.1C75.8,40.1,76,42,76,43.9z\"/>\n"
  "<path d=\"M89.2,0H10.8C4.8,0,0,4.8,0,10.8v78.4c0,6,4.8,10.8,10.8,10.8h78.4c6,0,10.8-4.8,10.8-10.8V10.8C100,4.8,95.2,0,89.2,0z M57.3,18.6c1.1,0.1,2.1,1.4,2.1,2.8c0,1.4-0.9,2.5-2.1,2.4c-1.2-0.1-2.1-1.3-2.1-2.8C55.2,19.5,56.1,18.4,57.3,18.6z M88.9,73.2L12,87.1V13.8l41.6,4.4c-0.4,0.7-0.6,1.6-0.6,2.6c0,1.5,0.5,2.8,1.3,3.8c-1.5,1.1-2.4,3.1-2.4,5.5c0,3.8,2.5,6.8,5.5,6.9c2.9,0.1,5.2-2.8,5.2-6.4c0-2.2-0.9-4.3-2.3-5.6c0.7-0.9,1.2-2.1,1.2-3.5c0-0.9-0.2-1.8-0.5-2.6c0,0,0,0,0,0l28.1,3V73.2z\"/>\n"
  "<path d=\"M84.5,33.9v-8l-15.7-1.3c2.3,2.4,4.1,5.4,5.3,8.8L84.5,33.9z\"/>\n"
  "</svg>";

const char s_copySvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-285 377 40 40\">\n"
  "<style type=\"text/css\">svg{cursor:pointer}path{fill:silver}</style>\n"
  "<path d=\"M-258,388h-4.2c-0.4-1.2-1.5-2-2.8-2s-2.4,0.8-2.8,2h-4.2c-1.1,0-2,0.9-2,2v16c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2v-16C-256,388.9-256.9,388-258,388L-258,388z M-265,388c0.6,0,1,0.4,1,1s-0.4,1-1,1s-1-0.4-1-1S-265.6,388-265,388L-265,388z M-258,406h-14v-16h2v3h10v-3h2V406L-258,406z\"/>\n"
  "</svg>";

const char s_refreshSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-309 393 40 40\">\n"
  "<style type=\"text/css\">svg{cursor:pointer}path{fill:silver}</style>\n"
  "<path d=\"M-280.4,413c-0.9,0-1.3,0.6-1.4,1.3c-0.5,2.3-2.7,5.9-7.1,5.9c-3.9,0-7.1-3.2-7.1-7.1s3.2-7.1,7.1-7.1c1.6,0,3.1,0.5,4.3,1.4h-1.4c-0.8,0-1.4,0.6-1.4,1.4s0.6,1.4,1.4,1.4h4.3c0.8,0,1.4-0.6,1.4-1.4v-4.3c0-0.8-0.6-1.4-1.4-1.4s-1.4,0.6-1.4,1.4v0.4c-1.6-1.1-3.6-1.8-5.7-1.8c-5.5,0-10,4.5-10,10s4.5,10,10,10c7.1,0,10-6.8,10-8.5C-279,413.5-279.8,413-280.4,413z\"/>\n"
  "</svg>";

const char s_showSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-29 31 40 40\">\n"
	"<style type=\"text/css\">path{fill:silver}</style>\n"
  "<path d=\"M-9,44.7c-4.4,0-8.1,2.5-10,6.3c1.9,3.7,5.6,6.3,10,6.3s8.1-2.5,10-6.3C-0.9,47.2-4.6,44.7-9,44.7z M-4.1,48c1.2,0.7,2.2,1.8,2.9,2.9c-0.7,1.2-1.7,2.2-2.9,2.9c-1.5,0.9-3.2,1.4-4.9,1.4s-3.5-0.5-4.9-1.4c-1.2-0.7-2.2-1.8-2.9-2.9c0.7-1.2,1.7-2.2,2.9-2.9c0.1,0,0.2-0.1,0.2-0.1c-0.2,0.5-0.3,1.1-0.3,1.7c0,2.8,2.2,5,5,5s5-2.2,5-5c0-0.6-0.1-1.2-0.3-1.7C-4.2,47.9-4.1,48-4.1,48z M-9,49c0,1-0.8,1.9-1.9,1.9s-1.9-0.8-1.9-1.9s0.8-1.9,1.9-1.9S-9,47.9-9,49z\"/>\n"
  "</svg>";

c_page myPages[] = {
  { "/index.html", "text/html", index_html },

  { "/config.html", "text/html", s_configHtml },
  { "/config.css", "text/css", s_configCss },
  { "/config.js", "application/javascript", s_configJs },

  { "/rsa-utils/rsa.js", "application/javascript", rsa_js },
  { "/style.css", "text/css", style_css },
  { "/rsa-utils/rng.js", "application/javascript", rng_js },
  { "/rsa-utils/jsbn_2.js", "application/javascript", jsbn_2_js },
  { "/rsa-utils/jsbn_1.js", "application/javascript", jsbn_1_js },
  { "/script.js", "application/javascript", script_js },
  { "/rsa-utils/prng4.js", "application/javascript", prng4_js },

  { "/logo.svg", "image/svg+xml", s_logoSvg },
  { "/copy.svg", "image/svg+xml", s_copySvg },
  { "/refresh.svg", "image/svg+xml", s_refreshSvg },
  { "/show.svg", "image/svg+xml", s_showSvg },
  { nullptr }
};

void f_pageHandler(const char* url, ResponseCallback* cb, void* cbArg, Reader* body, Writer* result, void* reserved) {
    Serial.printlnf("handling page %s", url);

    if (strcmp(url, "/index") == 0) {
        Serial.println("sending redirect");
        Header h("Location: /index.html\r\n");
        cb(cbArg, 0, 301, "text/plain", &h);
        return;
    }

    if (strcmp(url, "/config") == 0) {
      Serial.println("setting/getting config");
      char s_buffer[MAXNAMESIZE + 250];
      c_config& o_config = c_config::f_getInstance();
      o_config.f_getJsonConfig(s_buffer);
      cb(cbArg, 0, 200, "application/json", nullptr);
      result->write(s_buffer);
      return;
    }

    int8_t idx = 0;
    for (;;idx++) {
        c_page& p = myPages[idx];
        if (!p.url) {
            idx = -1;
            break;
        }
        else if (strcmp(url, p.url)==0) {
            break;
        }
    }

    if (idx == -1) {
      cb (cbArg, 0, 404, nullptr, nullptr);
    }
    else {

      const char* s_page = myPages[idx].data;
      int n_length = strlen(s_page);
      char s_header[100];
      sprintf(
        s_header,
        "Content-Length: %u\r\n",
        n_length
      );
      Header h(s_header);
      cb (cbArg, 0, 200, myPages[idx].mime_type, &h);
      result->write(s_page);
    }
}

// Press SETUP for 3 seconds to make the Photon enter Listening mode
// Navigate to http://192.168.0.1 to setup Wi-Fi

// Include the rest of your application below,
// including your setup and loop functions
