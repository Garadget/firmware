// $Id$
/**
 * @file door.cpp
 * @brief Garadget door class implementation
 * @author Denis Grisak
 * @version 1.9
 */
// $Log$

#include "webconfig.h"

const char s_configHtml[] = "<!DOCTYPE html><html><head><title>Garadet Web Admin</title><meta name=viewport content='width=device-width'><link rel=stylesheet type=text/css href=config.css><script>var f_copyId = f_togglePass = f_apChange = f_mqttChange = f_formSubmit = function(){};</script></head><body><div class=header><div class=lh><div class='header-content wl'><img src=logo.svg><h1 id=title>Setup</h1></div></div><div class=messages><ul class=error-box id=error-box style=display:none></ul><ul class=message-box id=message-box style=display:none></ul></div><div class=gh></div></div><form class='main wl'><div class=sg><h2>Device</h2><div class=fr><label>ID:</label><div class=ia><input type=text name=id disabled> <img src=copy.svg><div title='Copy Device ID' class=ab onclick=f_copyId()></div></div></div><div class=fr><label>System:</label><input type=text name=sys disabled></div><div class=fr><label>Firmware:</label><input type=text name=ver disabled></div></div><div class=sg><h2>WiFi</h2><div class=fr><label>SSID:</label><div class=ia><ul class=rg id=aplist><li>Loading...</li></ul><img src=refresh.svg><div title='Rescan WiFi' class=ab onclick=f_apScan()></div></div></div><div id=box-ssid style=display:none><div class=fr><label>Hidden/Unavailable SSID:</label><input type=text name=ap-manual id=ssid-value></div><div class=fr><label>Security:</label><select name=ap-sec id=sec-value onchange=f_apChange()></select></div><div class=fr><label>Channel:</label><select name=ap-chan id=chan-value></select></div></div><div class=fr id=box-pass style=display:none><label>Password:</label><div class=ia><input type=password name=pass id=ap-pass> <img src=show.svg><div title='Toggle Visibility' class=ab onclick=f_togglePass()></div></div></div></div><div class=sg><h2>MQTT</h2><div class=fr><label>Mode:</label><ul class=rg onclick=f_mqttChange()><li><input type=radio name=mqtt value=3><div>MQTT + Cloud</div></li><li><input type=radio name=mqtt value=2><div>Only MQTT</div></li><li><input type=radio name=mqtt value=1 checked><div>Only Cloud</div></li></ul></div><div id=box-mqtt style=display:none><div class=fr><label>Broker IP:</label><input type=text name=mqip placeholder=XXX.XXX.XXX.XXX></div><div class=fr><label>Broker Port:</label><input type=number name=mqpt value=1883></div><div class=fr><label>Device Topic ID:</label><input type=text name=nme value=door><div class=rn>Name uniquely identifying the device in MQTT topics e.g. /garadget/TOPIC_ID/open</div></div><div class=fr><label>Reconnect Timeout:</label><select name=mqto></select><div class=rn>Period to check the connection with server and reconnect if necessary</div></div></div></div><div class=sg><h2>Sensor</h2><div class=fr><label>Scan Period:</label><select name=rdt></select><div class=rn>Time between sensor scans</div></div><div class=fr><label>Sensor Threshold:</label><select name=srt></select><div class=rn>Lowest reflection reading to trigger the sensor</div></div></div><div class=sg><h2>Door</h2><div class=fr><label>Door Motion Time:</label><select name=mtt></select><div class=rn>Time it takes for door to completely open or close</div></div><div class=fr><label>Relay On Time:</label><select name=rlt></select><div class=rn>Duration of simulated button push</div></div><div class=fr><label>Relay Off Time:</label><select name=rlp></select><div class=rn>Time between consecutive button pushes</div></div></div></form><div class=footer><div class=gf></div><div class=liner-footer><div class='footer-content wl'><button class=button-passive id=btn-submit onclick=f_formSubmit()>Save &amp; Connect</button></div></div></div><script src=rsa-utils/jsbn_1.js></script><script src=rsa-utils/jsbn_2.js></script><script src=rsa-utils/prng4.js></script><script src=rsa-utils/rng.js></script><script src=rsa-utils/rsa.js></script><script src=config1.js></script><script src=config2.js></script></body></html>";

const char s_configCss[] = "html{height:100%;margin:0}body{margin:0;text-align:center;font-family:Helvetica,sans-serif;font-size:16px}a,a:visited,lh a:active{text-decoration:none}.footer,.header{position:fixed;width:100%;z-index:9}.header{top:0}.footer{bottom:0;text-align:right}.lh,.liner-footer{background-color:#060}.wl{max-width:600px;margin:0 auto;padding:10px 15px}.header img{height:50px;float:left}h1{color:#fff;font-weight:400;margin:0;font-size:30px;line-height:50px;text-transform:uppercase}.main{padding:100px 0}.messages ul{padding:10px 25px;margin:0}.messages li{max-width:600px;margin:0 auto;text-align:left}.error-box{background-color:#ffe0e0}.message-box{background-color:#e0ffe0}.gh{height:25px;border-top:5px solid #fff;background:linear-gradient(white,transparent)}.gf{height:25px;border-bottom:5px solid #fff;background:linear-gradient(transparent,#fff)}.sg{margin:10px 10px 20px 10px}.rg{list-style:none;margin:0 0;padding:5px 15px;border:1px solid silver}.rg li{margin:5px 0 5px 0;padding:0}.rg *{margin:0;padding:0;vertical-align:middle}.rg div{display:inline-block;margin-left:7px}.rg span{display:block;font-size:10px;color:grey}li.wifi-manual{margin-top:15px;font-style:italic}h2{text-align:left;margin:0 15px 10px 15px;border-bottom:4px solid silver}.fr{max-width:300px;margin:0 auto 10px auto;text-align:left}.submit-row{max-width:300px;margin:20px auto}.submit-bar{padding:10px 0;text-align:right;flex-shrink:0}.fr label{display:block;margin:0;color:gray}.fr input[type=number],.fr input[type=password],.fr input[type=text],.fr select{width:100%;padding:10px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;border:1px solid silver;font-size:16px}.ia{position:relative}.ab,.ia img{position:absolute;cursor:pointer;max-height:40px;max-width:40px;overflow:auto;margin:auto 0 auto auto;top:0;left:0;bottom:0;right:0}.rn{font-size:10px;color:silver;margin-top:2px}button{min-width:150px;color:#fff;border-left:0;border-top:0;border-right:0;font-weight:700;font-size:20px;padding:15px 20px;cursor:pointer;background-color:#f46809;border-bottom:2px solid #b24c07}button:hover{background-color:#b24c07}.button-passive{background-color:grey;border-bottom:2px solid #606060;cursor:not-allowed}.button-passive:hover{background-color:grey}";

const char s_config1Js[] = "function f_postRequest(t,s,e){var i=new XMLHttpRequest;i.open(\"POST\",s_baseUrl+t,!0),i.timeout=4e3,i.setRequestHeader(\"Content-Type\",\"multipart/form-data\"),i.onreadystatechange=function(){4==i.readyState&&e&&(window.n_busy--,200==i.status?e.success&&e.success(JSON.parse(i.responseText)):e.error&&e.error(i.status,i.responseText),e.regardless&&e.regardless())},window.n_busy=(window.n_busy||0)+1,i.send(JSON.stringify(s))}function f_getRequest(t,s){var e=new XMLHttpRequest;e.open(\"GET\",s_baseUrl+t,!0),e.timeout=8e3,e.onreadystatechange=function(){4==e.readyState&&s&&(window.n_busy--,200==e.status?s.success&&s.success(JSON.parse(e.responseText)):s.error&&s.error(e.status,e.responseText),s.regardless&&s.regardless())},window.n_busy=(window.n_busy||0)+1,e.send()}function f_getById(t){var s=document.getElementById(t);return s||document.forms[0].elements[t]}function f_inputValue(t,s){var e=document.forms[0].elements[t];if(!e)return!1;var i,n;if(e.options){if(i=e.options[e.selectedIndex].value,arguments.length>1)for(n=0;n<e.options.length;n++)if(e.options[n].value==s){e.selectedIndex=n;break}}else if(\"checkbox\"==e.type)i=!!e.checked&&e.value,e.checked=s;else if(e.length){var a=-1;for(n=0;n<e.length;n++)arguments.length>1&&e[n].value==s&&(a=n),e[n].checked&&(i=e[n].value);a>=0&&(e[a].checked=!0)}return void 0!=e.value&&(i=e.value,arguments.length>1&&(e.value=s)),i}function f_populateSelect(t,s,e,i){var n=document.forms[0].elements[t];n.options.length=0;for(var a,u=!1,r=0;r<s.length;r+=2)a=s[r+1],n.options[n.options.length]=new Option(s[r],a),arguments.length>3&&a==i&&(n.selectedIndex=r/2,u=!0);!u&&arguments.length>2&&f_inputValue(t,e)}function f_signalStrength(t){var s;return s=t<=-85?\"poor\":t<=-60?\"good\":\"excellent\",t+\"dB (\"+s+\")\"}function f_copyId(){window.prompt(\"Copy to clipboard: Ctrl + C, Enter\",f_inputValue(\"id\"))}function f_togglePass(){var t=f_getById(\"ap-pass\");t.type=\"password\"==t.type?\"text\":\"password\"}function f_submitValid(t){var s=f_getById(\"btn-submit\");return t?s.className=s.className.replace(/\\s*button-passive\\s*/,\"\"):s.className.match(\"button-passive\")||(s.className+=\" button-passive\"),t}function f_message(t,s){var e=f_getById(s?\"error-box\":\"message-box\");t?(e.innerHTML=\"<li>\"+t+\"</li>\",e.style.display=\"block\",setTimeout(function(){f_message(\"\",s)},5e3)):e.style.display=\"none\"}function f_validate(t,s){document.forms[0].elements[t].onkeyup=s}var c_validator=function(){this.a_flags={ssid:!1,pass:!1,mqip:!1,mqpt:!1,nme:!1,pkey:!1},this.f_isValid=function(){if(window.b_busy)return!1;for(var t in this.a_flags)if(!this.a_flags[t])return!1;return!0},this.f_setSubmit=function(){f_getById(\"btn-submit\").className=this.f_isValid()?\"\":\"button-passive\"},this.f_setValid=function(t,s){this.a_flags[t]=s,this.f_setSubmit()},this.f_checkValid=function(t){this.s_focus=\"\";var s=t.split(\",\");for(var e in s){var i=s[e];this.a_flags[i]=this[\"f_val\"+i]()}this.f_setSubmit()},this.f_focus=function(t){this.s_focus||(this.s_focus=t)},this.a_tests={},this.f_valssid=function(){return this.a_tests[0]=[],-1!=f_inputValue(\"ap\")?(f_boxManual(!1),!0):(f_boxManual(!0),!!f_inputValue(\"ssid-value\").length||(this.a_tests[0].push(\"SSID is Requred for Manual Configuration\"),this.f_focus(\"ssid-value\"),!1))},this.f_valpass=function(){this.a_tests[1]=[];var t=f_inputValue(\"ap\");if(t<0&&!parseInt(f_inputValue(\"ap-sec\"))||t>=0&&!a_networks[t].sec)return f_boxPass(!1),!0;f_boxPass(!0);var s=f_inputValue(\"pass\");return s.length>7||(this.a_tests[1].push(s.length?\"WiFi Password is Too Short\":\"Password is Required for Secured Network\"),this.f_focus(\"ap-pass\"),!1)},this.f_valmqip=function(){if(this.a_tests[2]=[],!(2&f_inputValue(\"mqtt\")))return f_boxSwitch(!1,\"box-mqtt\"),!0;f_boxSwitch(!0,\"box-mqtt\");var t=f_inputValue(\"mqip\");if(!t.length)return this.a_tests[2].push(\"MQTT Server IP is Required\"),this.f_focus(\"mqip\"),!1;for(var s=t.split(\".\"),e=0;e<4;e++)if(4!=s.length||\"\"==s[e]||isNaN(s[e])||s[e]<0||s[e]>255)return this.a_tests[2].push(\"Invalid Format of MQTT Server IP\"),this.f_focus(\"mqip\"),!1;return!0},this.f_valmqpt=function(){if(this.a_tests[3]=[],!(2&f_inputValue(\"mqtt\")))return!0;var t=f_inputValue(\"mqpt\");return t.length?!(isNaN(t)||t<=0||t>65535)||(this.a_tests[3].push(\"Invalid Value of MQTT Server Port\"),this.f_focus(\"mqpt\"),!1):(this.a_tests[3].push(\"MQTT Server Port is Required\"),this.f_focus(\"mqpt\"),!1)},this.f_valnme=function(){if(this.a_tests[4]=[],!(2&f_inputValue(\"mqtt\")))return!0;var t=f_inputValue(\"nme\");return t.length?!!t.match(/^[\\w\\d\\_]{1,31}$/)||(this.a_tests[4].push(\"Invalid Value of MQTT Device Topic\"),this.f_focus(\"nme\"),!1):(this.a_tests[4].push(\"MQTT Device Topic is Required\"),this.f_focus(\"nme\"),!1)},this.f_getErrors=function(){var t=[];for(var s in this.a_tests)if(this.a_tests[s].length)for(var e in this.a_tests[s])t.push(this.a_tests[s][e]);return this.s_focus&&f_getById(this.s_focus).focus(),t}};";

const char s_config2Js[] = "function f_boxSwitch(e,s,t){var n=f_getById(s).style,a=e?\"\":\"none\";if(n.display!=a&&(n.display=a,e&&t)){var i=f_getById(t);i.value=\"\",i.focus()}}function f_boxManual(e){f_boxSwitch(e,\"box-ssid\",\"ssid-value\")}function f_boxPass(e){f_boxSwitch(e,\"box-pass\",\"ap-pass\")}function f_apChange(e){o_val.f_checkValid(\"pass,ssid\")}function f_mqttChange(){o_val.f_checkValid(\"mqip,mqpt,nme\")}function f_loadConfig(e){var s=!1;f_getRequest(\"load-config\",{success:function(e){for(var t=[\"id\",\"sys\",\"ver\",\"mqtt\",\"mqip\",\"mqpt\",\"nme\"],n=0;n<t.length;n++)f_inputValue(t[n],e[t[n]]);f_populateSelect(\"mqto\",[\"1 second\",1,\"2 seconds\",2,\"3 seconds\",3,\"5 seconds\",5,\"10 seconds\",10,\"15 seconds\",15,\"30 seconds\",30,\"1 minute\",60,\"5 minutes\",300],15,e.mqto),f_populateSelect(\"rdt\",[\"twice per second\",500,\"every second\",1e3,\"every 2 seconds\",2e3,\"every 3 seconds\",3e3,\"every 5 seconds\",5e3,\"every 10 seconds\",1e4,\"twice per minute\",3e4,\"every minute\",6e4],1e3,e.rdt);var a,i=[];for(a in a_securityTypes)i[i.length]=a_securityTypes[a],i[i.length]=a;for(f_populateSelect(\"sec-value\",i,4194308),i=[],a=1;a<=14;a++)i[i.length]=a,i[i.length]=a;for(f_populateSelect(\"chan-value\",i,6),i=[\"3%\",3],a=5;a<=80;a+=5)i[i.length]=a+\"%\",i[i.length]=a;for(f_populateSelect(\"srt\",i,10,e.srt),i=[],a=5;a<=30;a++)i[i.length]=a+\" seconds\",i[i.length]=1e3*a;for(f_populateSelect(\"mtt\",i,1e4,e.mtt),f_populateSelect(\"rlt\",[\"0.2 second\",200,\"0.3 second\",300,\"0.4 second\",400,\"0.5 second\",500,\"0.7 second\",700,\"1 second\",1e3],e.rlt),i=[],a=300;a<=1e3;a+=100)i[i.length]=a/1e3+\" second\",i[i.length]=a;for(a=2;a<=5;a+=1)i[i.length]=a+\" seconds\",i[i.length]=1e3*a;f_populateSelect(\"rlp\",i,[],e.rlp),window.s_ssid=e.ssid||\"\",s=!0},error:function(){f_message(\"Error Requesting Configuration\",!0)},regardless:function(){e(s)}})}function f_apScan(){var e=f_getById(\"aplist\");e.innerHTML=\"<li>Loading...</li>\",f_boxPass(!1),f_boxManual(!1);var s=\"\",t=!1,n=!0;f_getRequest(\"scan-ap\",{success:function(e){var a;for(window.a_networks=e.scans,a=0;a<a_networks.length;a++)a_networks[a].value=a;for(a_networks.sort(function(e,s){return s.rssi-e.rssi}),a=0;a<a_networks.length;a++){var i=\"\",o=a_networks[a];t||window.s_ssid!=o.ssid||(t=!0,i=\" checked\",o.sec||(n=!1)),s+=\"<li><input type=radio name=ap value=\"+a+i+' onclick=\"f_apChange()\" /><div>'+o.ssid+\"<span>\"+(a_securityTypes[o.sec]?a_securityTypes[o.sec]+\", \":\"\")+\"Ch\"+o.ch+\", \"+f_signalStrength(o.rssi)+\"</span></div></li>\"}a||(s+=\"<li>No networks found</li>\")},error:function(){f_message(\"Error Scanning Networks\",!0)},regardless:function(){s+='<li><input type=radio name=ap value=\"-1\"'+(t?\"\":\" checked\")+' onclick=\"f_apChange(this.value)\" onclick=\"f_apChange()\" /><div>Enter Manually<span>Use For Hidden or Currently Unavailable Networks</span></div></li>',e.innerHTML=s,o_val.f_checkValid(\"pass,ssid\")}})}function f_loadKey(){o_val.f_setValid(\"pkey\",!1),f_getRequest(\"public-key\",{success:function(e){var s=e.b;o_rsa.setPublic(s.substring(58,314),s.substring(318,324)),o_val.f_setValid(\"pkey\",!0)},error:function(){f_message(\"Error Requesting Public Key\",!0)}})}function f_formSubmit(){if(!o_val.f_isValid())return f_message(o_val.f_getErrors().join(\"</li><li>\"),!0),!1;var e={idx:0,pwd:o_rsa.encrypt(f_inputValue(\"ap-pass\"))},s=f_inputValue(\"ap\");if(s>=0){var t=a_networks[s];e.ssid=t.ssid,e.sec=t.sec,e.ch=t.ch}else e.ssid=f_inputValue(\"ssid-value\"),e.sec=parseInt(f_inputValue(\"sec-value\")),e.ch=parseInt(f_inputValue(\"chan-value\"));return f_submitValid(!1),f_message(\"Saving credentials...\"),f_postRequest(\"configure-ap\",e,{success:function(e){if(0!==e.r)return f_configError(e.r);var s={},t={nme:0,rdt:1,mtt:1,rlt:1,rlp:1,srt:1,mqtt:1,mqip:0,mqpt:1,mqto:1};for(var n in t){var a=f_inputValue(n);t[n]&&(a=parseInt(a)),s[n]=a}f_message(\"Saving settings...\"),f_postRequest(\"save-config\",s,{success:function(e){if(0!==e.r)return f_configError(e.r);f_message(\"Connecting WiFi...\"),f_postRequest(\"connect-ap\",{idx:0},{success:function(e){f_message(\"All Set! Leaving Setup...\")}})},error:f_configError})},error:f_configError,regardless:function(){}}),!1}function f_configError(e,s){console.log(e+\": \"+s),f_message(),f_message(\"Error saving the Settings.<br />Check that you are still well connected to the device's WiFi hotspot and retry.\",!0),f_submitValid(!0)}var s_baseUrl=\"http://192.168.0.1/\",a_networks=[],a_securityTypes={0:\"Not Secured\",1:\"WEP pre-shared key\",32769:\"Open WEP\",2097154:\"WPA with TKIP\",2097156:\"WPA with AES\",4194308:\"WPA2 with TKIP\",4194306:\"WPA2 with AES\",4194310:\"WPA2 AES & TKIP\"},o_rsa=new RSAKey,o_val=new c_validator;window.onload=function(){f_validate(\"ssid-value\",function(){o_val.f_checkValid(\"ssid\")}),f_validate(\"pass\",function(){o_val.f_checkValid(\"pass\")}),f_validate(\"mqip\",function(e){for(var s=e.target.value.replace(/[^\\d\\.]+/,\"\").replace(\"..\",\".\").replace(/^\\./,\"\").split(\".\"),t=0;t<Math.min(4,s.length);t++)s[t]>255&&(s[t]=Math.floor(s[t]/10));e.target.value=s.join(\".\"),o_val.f_checkValid(\"mqip\")}),f_validate(\"mqpt\",function(e){var s=e.target.value;(s=s.replace(/\\D+/,\"\"))>65535&&(s=Math.floor(s/10)),e.target.value=s,o_val.f_checkValid(\"mqpt\")}),f_validate(\"nme\",function(e){e.target.value=e.target.value.replace(/[^\\w\\d\\_]+/,\"\").substring(0,30),o_val.f_checkValid(\"nme\")}),f_loadConfig(function(e){f_mqttChange(),f_loadKey(),f_apScan()})};";

const char rsa_js[] = "function parseBigInt(a,b){return new BigInteger(a,b);}function linebrk(a,b){var c='';var d=0;while(d+b<a.length){c+=a.substring(d,d+b)+'\\n';d+=b;}return c+a.substring(d,a.length);}function byte2Hex(a){if(a<0x10)return '0'+a.toString(16);else return a.toString(16);}function pkcs1pad2(a,b){if(b<a.length+11){alert('Message too long for RSA');return null;}var c=new Array();var d=a.length-1;while(d>=0&&b>0){var e=a.charCodeAt(d--);if(e<128)c[--b]=e;else if((e>127)&&(e<2048)){c[--b]=(e&63)|128;c[--b]=(e>>6)|192;}else{c[--b]=(e&63)|128;c[--b]=((e>>6)&63)|128;c[--b]=(e>>12)|224;}}c[--b]=0;var f=new SecureRandom();var g=new Array();while(b>2){g[0]=0;while(g[0]==0)f.nextBytes(g);c[--b]=g[0];}c[--b]=2;c[--b]=0;return new BigInteger(c);}function RSAKey(){this.n=null;this.e=0;this.d=null;this.p=null;this.q=null;this.dmp1=null;this.dmq1=null;this.coeff=null;}function RSASetPublic(a,b){if(a!=null&&b!=null&&a.length>0&&b.length>0){this.n=parseBigInt(a,16);this.e=parseInt(b,16);}else alert('Invalid RSA public key');}function RSADoPublic(a){return a.modPowInt(this.e,this.n);}function RSAEncrypt(a){var b=pkcs1pad2(a,(this.n.bitLength()+7)>>3);if(b==null)return null;var c=this.doPublic(b);if(c==null)return null;var d=c.toString(16);if((d.length&1)==0)return d;else return '0'+d;}RSAKey.prototype.doPublic=RSADoPublic;RSAKey.prototype.setPublic=RSASetPublic;RSAKey.prototype.encrypt=RSAEncrypt;";

const char rng_js[] = "var rng_state;var rng_pool;var rng_pptr;function rng_seed_int(a){rng_pool[rng_pptr++]^=a&255;rng_pool[rng_pptr++]^=(a>>8)&255;rng_pool[rng_pptr++]^=(a>>16)&255;rng_pool[rng_pptr++]^=(a>>24)&255;if(rng_pptr>=rng_psize)rng_pptr-=rng_psize;}function rng_seed_time(){rng_seed_int(new Date().getTime());}if(rng_pool==null){rng_pool=new Array();rng_pptr=0;var t;if(window.crypto&&window.crypto.getRandomValues){var ua=new Uint8Array(32);window.crypto.getRandomValues(ua);for(t=0;t<32;++t)rng_pool[rng_pptr++]=ua[t];}if(navigator.appName=='Netscape'&&navigator.appVersion<'5'&&window.crypto){var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=z.charCodeAt(t)&255;}while(rng_pptr<rng_psize){t=Math.floor(65536*Math.random());rng_pool[rng_pptr++]=t>>>8;rng_pool[rng_pptr++]=t&255;}rng_pptr=0;rng_seed_time();}function rng_get_byte(){if(rng_state==null){rng_seed_time();rng_state=prng_newstate();rng_state.init(rng_pool);for(rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0;}return rng_state.next();}function rng_get_bytes(a){var b;for(b=0;b<a.length;++b)a[b]=rng_get_byte();}function SecureRandom(){}SecureRandom.prototype.nextBytes=rng_get_bytes;";

const char jsbn_2_js[] = "function bnpRShiftTo(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t){b.t=0;return;}var d=a%this.DB;var e=this.DB-d;var f=(1<<d)-1;b[0]=this[c]>>d;for(var g=c+1;g<this.t;++g){b[g-c-1]|=(this[g]&f)<<e;b[g-c]=this[g]>>d;}if(d>0)b[this.t-c-1]|=(this.s&f)<<e;b.t=this.t-c;b.clamp();}function bnpSubTo(a,b){var c=0,d=0,e=Math.min(a.t,this.t);while(c<e){d+=this[c]-a[c];b[c++]=d&this.DM;d>>=this.DB;}if(a.t<this.t){d-=a.s;while(c<this.t){d+=this[c];b[c++]=d&this.DM;d>>=this.DB;}d+=this.s;}else{d+=this.s;while(c<a.t){d-=a[c];b[c++]=d&this.DM;d>>=this.DB;}d-=a.s;}b.s=(d<0)?-1:0;if(d<-1)b[c++]=this.DV+d;else if(d>0)b[c++]=d;b.t=c;b.clamp();}function bnpMultiplyTo(a,b){var c=this.abs(),d=a.abs();var e=c.t;b.t=e+d.t;while(--e>=0)b[e]=0;for(e=0;e<d.t;++e)b[e+c.t]=c.am(0,d[e],b,e,0,c.t);b.s=0;b.clamp();if(this.s!=a.s)BigInteger.ZERO.subTo(b,b);}function bnpSquareTo(a){var b=this.abs();var c=a.t=2*b.t;while(--c>=0)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);if((a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV){a[c+b.t]-=b.DV;a[c+b.t+1]=1;}}if(a.t>0)a[a.t-1]+=b.am(c,b[c],a,2*c,0,1);a.s=0;a.clamp();}function bnpDivRemTo(a,b,c){var d=a.abs();if(d.t<=0)return;var e=this.abs();if(e.t<d.t){if(b!=null)b.fromInt(0);if(c!=null)this.copyTo(c);return;}if(c==null)c=nbi();var f=nbi(),g=this.s,h=a.s;var i=this.DB-nbits(d[d.t-1]);if(i>0){d.lShiftTo(i,f);e.lShiftTo(i,c);}else{d.copyTo(f);e.copyTo(c);}var j=f.t;var k=f[j-1];if(k==0)return;var l=k*(1<<this.F1)+((j>1)?f[j-2]>>this.F2:0);var m=this.FV/l,n=(1<<this.F1)/l,o=1<<this.F2;var p=c.t,q=p-j,r=(b==null)?nbi():b;f.dlShiftTo(q,r);if(c.compareTo(r)>=0){c[c.t++]=1;c.subTo(r,c);}BigInteger.ONE.dlShiftTo(j,r);r.subTo(f,f);while(f.t<j)f[f.t++]=0;while(--q>=0){var s=(c[--p]==k)?this.DM:Math.floor(c[p]*m+(c[p-1]+o)*n);if((c[p]+=f.am(0,s,c,q,0,j))<s){f.dlShiftTo(q,r);c.subTo(r,c);while(c[p]<--s)c.subTo(r,c);}}if(b!=null){c.drShiftTo(j,b);if(g!=h)BigInteger.ZERO.subTo(b,b);}c.t=j;c.clamp();if(i>0)c.rShiftTo(i,c);if(g<0)BigInteger.ZERO.subTo(c,c);}function bnMod(a){var b=nbi();this.abs().divRemTo(a,null,b);if(this.s<0&&b.compareTo(BigInteger.ZERO)>0)a.subTo(b,b);return b;}function Classic(a){this.m=a;}function cConvert(a){if(a.s<0||a.compareTo(this.m)>=0)return a.mod(this.m);else return a;}function cRevert(a){return a;}function cReduce(a){a.divRemTo(this.m,null,a);}function cMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c);}function cSqrTo(a,b){a.squareTo(b);this.reduce(b);}Classic.prototype.convert=cConvert;Classic.prototype.revert=cRevert;Classic.prototype.reduce=cReduce;Classic.prototype.mulTo=cMulTo;Classic.prototype.sqrTo=cSqrTo;function bnpInvDigit(){if(this.t<1)return 0;var a=this[0];if((a&1)==0)return 0;var b=a&3;b=(b*(2-(a&0xf)*b))&0xf;b=(b*(2-(a&0xff)*b))&0xff;b=(b*(2-(((a&0xffff)*b)&0xffff)))&0xffff;b=(b*(2-a*b%this.DV))%this.DV;return(b>0)?this.DV-b:-b;}function Montgomery(a){this.m=a;this.mp=a.invDigit();this.mpl=this.mp&0x7fff;this.mph=this.mp>>15;this.um=(1<<(a.DB-15))-1;this.mt2=2*a.t;}function montConvert(a){var b=nbi();a.abs().dlShiftTo(this.m.t,b);b.divRemTo(this.m,null,b);if(a.s<0&&b.compareTo(BigInteger.ZERO)>0)this.m.subTo(b,b);return b;}function montRevert(a){var b=nbi();a.copyTo(b);this.reduce(b);return b;}function montReduce(a){while(a.t<=this.mt2)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=a[b]&0x7fff;var d=(c*this.mpl+(((c*this.mph+(a[b]>>15)*this.mpl)&this.um)<<15))&a.DM;c=b+this.m.t;a[c]+=this.m.am(0,d,a,b,0,this.m.t);while(a[c]>=a.DV){a[c]-=a.DV;a[++c]++;}}a.clamp();a.drShiftTo(this.m.t,a);if(a.compareTo(this.m)>=0)a.subTo(this.m,a);}function montSqrTo(a,b){a.squareTo(b);this.reduce(b);}function montMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c);}Montgomery.prototype.convert=montConvert;Montgomery.prototype.revert=montRevert;Montgomery.prototype.reduce=montReduce;Montgomery.prototype.mulTo=montMulTo;Montgomery.prototype.sqrTo=montSqrTo;function bnpIsEven(){return((this.t>0)?(this[0]&1):this.s)==0;}function bnpExp(a,b){if(a>0xffffffff||a<1)return BigInteger.ONE;var c=nbi(),d=nbi(),e=b.convert(this),f=nbits(a)-1;e.copyTo(c);while(--f>=0){b.sqrTo(c,d);if((a&(1<<f))>0)b.mulTo(d,e,c);else{var g=c;c=d;d=g;}}return b.revert(c);}function bnModPowInt(a,b){var c;if(a<256||b.isEven())c=new Classic(b);else c=new Montgomery(b);return this.exp(a,c);}BigInteger.prototype.copyTo=bnpCopyTo;BigInteger.prototype.fromInt=bnpFromInt;BigInteger.prototype.fromString=bnpFromString;BigInteger.prototype.clamp=bnpClamp;BigInteger.prototype.dlShiftTo=bnpDLShiftTo;BigInteger.prototype.drShiftTo=bnpDRShiftTo;BigInteger.prototype.lShiftTo=bnpLShiftTo;BigInteger.prototype.rShiftTo=bnpRShiftTo;BigInteger.prototype.subTo=bnpSubTo;BigInteger.prototype.multiplyTo=bnpMultiplyTo;BigInteger.prototype.squareTo=bnpSquareTo;BigInteger.prototype.divRemTo=bnpDivRemTo;BigInteger.prototype.invDigit=bnpInvDigit;BigInteger.prototype.isEven=bnpIsEven;BigInteger.prototype.exp=bnpExp;BigInteger.prototype.toString=bnToString;BigInteger.prototype.negate=bnNegate;BigInteger.prototype.abs=bnAbs;BigInteger.prototype.compareTo=bnCompareTo;BigInteger.prototype.bitLength=bnBitLength;BigInteger.prototype.mod=bnMod;BigInteger.prototype.modPowInt=bnModPowInt;BigInteger.ZERO=nbv(0);BigInteger.ONE=nbv(1);";

const char jsbn_1_js[] = "var dbits;var canary=0xdeadbeefcafe;var j_lm=((canary&0xffffff)==0xefcafe);function BigInteger(a,b,c){if(a!=null)if('number'==typeof a)this.fromNumber(a,b,c);else if(b==null&&'string'!=typeof a)this.fromString(a,256);else this.fromString(a,b);}function nbi(){return new BigInteger(null);}function am1(a,b,c,d,e,f){while(--f>=0){var g=b*this[a++]+c[d]+e;e=Math.floor(g/0x4000000);c[d++]=g&0x3ffffff;}return e;}function am2(a,b,c,d,e,f){var g=b&0x7fff,h=b>>15;while(--f>=0){var i=this[a]&0x7fff;var j=this[a++]>>15;var k=h*i+j*g;i=g*i+((k&0x7fff)<<15)+c[d]+(e&0x3fffffff);e=(i>>>30)+(k>>>15)+h*j+(e>>>30);c[d++]=i&0x3fffffff;}return e;}function am3(a,b,c,d,e,f){var g=b&0x3fff,h=b>>14;while(--f>=0){var i=this[a]&0x3fff;var j=this[a++]>>14;var k=h*i+j*g;i=g*i+((k&0x3fff)<<14)+c[d]+e;e=(i>>28)+(k>>14)+h*j;c[d++]=i&0xfffffff;}return e;}if(j_lm&&(navigator.appName=='Microsoft Internet Explorer')){BigInteger.prototype.am=am2;dbits=30;}else if(j_lm&&(navigator.appName!='Netscape')){BigInteger.prototype.am=am1;dbits=26;}else{BigInteger.prototype.am=am3;dbits=28;}BigInteger.prototype.DB=dbits;BigInteger.prototype.DM=((1<<dbits)-1);BigInteger.prototype.DV=(1<<dbits);var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP);BigInteger.prototype.F1=BI_FP-dbits;BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM='0123456789abcdefghijklmnopqrstuvwxyz';var BI_RC=new Array();var rr,vv;rr='0'.charCodeAt(0);for(vv=0;vv<=9;++vv)BI_RC[rr++]=vv;rr='a'.charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;rr='A'.charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(a){return BI_RM.charAt(a);}function intAt(a,b){var c=BI_RC[a.charCodeAt(b)];return(c==null)?-1:c;}function bnpCopyTo(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t;a.s=this.s;}function bnpFromInt(a){this.t=1;this.s=(a<0)?-1:0;if(a>0)this[0]=a;else if(a<-1)this[0]=a+this.DV;else this.t=0;}function nbv(a){var b=nbi();b.fromInt(a);return b;}function bnpFromString(a,b){var c;if(b==16)c=4;else if(b==8)c=3;else if(b==256)c=8;else if(b==2)c=1;else if(b==32)c=5;else if(b==4)c=2;else{this.fromRadix(a,b);return;}this.t=0;this.s=0;var d=a.length,e=false,f=0;while(--d>=0){var g=(c==8)?a[d]&0xff:intAt(a,d);if(g<0){if(a.charAt(d)=='-')e=true;continue;}e=false;if(f==0)this[this.t++]=g;else if(f+c>this.DB){this[this.t-1]|=(g&((1<<(this.DB-f))-1))<<f;this[this.t++]=(g>>(this.DB-f));}else this[this.t-1]|=g<<f;f+=c;if(f>=this.DB)f-=this.DB;}if(c==8&&(a[0]&0x80)!=0){this.s=-1;if(f>0)this[this.t-1]|=((1<<(this.DB-f))-1)<<f;}this.clamp();if(e)BigInteger.ZERO.subTo(this,this);}function bnpClamp(){var a=this.s&this.DM;while(this.t>0&&this[this.t-1]==a)--this.t;}function bnToString(a){if(this.s<0)return '-'+this.negate().toString(a);var b;if(a==16)b=4;else if(a==8)b=3;else if(a==2)b=1;else if(a==32)b=5;else if(a==4)b=2;else return this.toRadix(a);var c=(1<<b)-1,d,e=false,f='',g=this.t;var h=this.DB-(g*this.DB)%b;if(g-->0){if(h<this.DB&&(d=this[g]>>h)>0){e=true;f=int2char(d);}while(g>=0){if(h<b){d=(this[g]&((1<<h)-1))<<(b-h);d|=this[--g]>>(h+=this.DB-b);}else{d=(this[g]>>(h-=b))&c;if(h<=0){h+=this.DB;--g;}}if(d>0)e=true;if(e)f+=int2char(d);}}return e?f:'0';}function bnNegate(){var a=nbi();BigInteger.ZERO.subTo(this,a);return a;}function bnAbs(){return(this.s<0)?this.negate():this;}function bnCompareTo(a){var b=this.s-a.s;if(b!=0)return b;var c=this.t;b=c-a.t;if(b!=0)return(this.s<0)?-b:b;while(--c>=0)if((b=this[c]-a[c])!=0)return b;return 0;}function nbits(a){var b=1,c;if((c=a>>>16)!=0){a=c;b+=16;}if((c=a>>8)!=0){a=c;b+=8;}if((c=a>>4)!=0){a=c;b+=4;}if((c=a>>2)!=0){a=c;b+=2;}if((c=a>>1)!=0){a=c;b+=1;}return b;}function bnBitLength(){if(this.t<=0)return 0;return this.DB*(this.t-1)+nbits(this[this.t-1]^(this.s&this.DM));}function bnpDLShiftTo(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a;b.s=this.s;}function bnpDRShiftTo(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0);b.s=this.s;}function bnpLShiftTo(a,b){var c=a%this.DB;var d=this.DB-c;var e=(1<<d)-1;var f=Math.floor(a/this.DB),g=(this.s<<c)&this.DM,h;for(h=this.t-1;h>=0;--h){b[h+f+1]=(this[h]>>d)|g;g=(this[h]&e)<<c;}for(h=f-1;h>=0;--h)b[h]=0;b[f]=g;b.t=this.t+f+1;b.s=this.s;b.clamp();}";

const char prng4_js[] = "function Arcfour(){this.i=0;this.j=0;this.S=new Array();}function ARC4init(a){var b,c,d;for(b=0;b<256;++b)this.S[b]=b;c=0;for(b=0;b<256;++b){c=(c+this.S[b]+a[b%a.length])&255;d=this.S[b];this.S[b]=this.S[c];this.S[c]=d;}this.i=0;this.j=0;}function ARC4next(){var a;this.i=(this.i+1)&255;this.j=(this.j+this.S[this.i])&255;a=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=a;return this.S[(a+this.S[this.i])&255];}Arcfour.prototype.init=ARC4init;Arcfour.prototype.next=ARC4next;function prng_newstate(){return new Arcfour();}var rng_psize=256;";

const char s_logoSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"0 0 100 100\">\n"
  "<style type=\"text/css\">path{fill:white}</style>\n"
  "<path d=\"M57.3,69.7c-4.6,0.6-9.1-0.7-12.8-3.4l-24.1,2.7v10.5l64.1-10v-7.8l-15.9,1.8C65.6,66.9,61.7,69.1,57.3,69.7z\"/>\n"
  "<path d=\"M35.4,52.1l-15,0.7V63l19.2-1.7C37.7,58.7,36.3,55.5,35.4,52.1z\"/>\n"
  "<path d=\"M44.3,22.7l-23.9-1.9v10.7l16.7,0.6C38.8,28.2,41.3,25,44.3,22.7z\"/>\n"
  "<path d=\"M72.4,58.4l12.1-1.1v-7.6l-9.2,0.4C74.8,53.1,73.8,55.9,72.4,58.4z\"/>\n"
  "<path d=\"M34.5,44.6c0-2.4,0.3-4.7,0.7-6.9l-14.8-0.2v9.3l14.2-0.3C34.5,45.8,34.5,45.2,34.5,44.6z\"/>\n"
  "<path d=\"M57.3,55.4c-8.5,0.6-16-7.8-16-18.8c0-0.7,0-1.3,0.1-2c-1.2,2.9-1.9,6.2-1.9,9.7c0,12.1,8.4,21.2,17.8,20.2c8.9-1,15.3-10.3,15.3-20.7c0-2.9-0.5-5.6-1.4-8.2c0,0.5,0,1,0,1.5C71.2,46.7,65.3,54.9,57.3,55.4z\"/>\n"
  "<path d=\"M47.4,30.2c-0.9,1.9-1.4,4.1-1.4,6.5c0,7.8,5.3,13.8,11.3,13.5c5.9-0.3,10.2-6.2,10.2-13.1c0-2.1-0.4-4.2-1.1-6c-0.2,6-4,10.9-9.1,11C52.1,42.1,47.5,36.9,47.4,30.2z\"/>\n"
  "<path d=\"M76,43.9c0,0.5,0,1,0,1.5l8.6-0.2v-6.9l-9.1-0.1C75.8,40.1,76,42,76,43.9z\"/>\n"
  "<path d=\"M89.2,0H10.8C4.8,0,0,4.8,0,10.8v78.4c0,6,4.8,10.8,10.8,10.8h78.4c6,0,10.8-4.8,10.8-10.8V10.8C100,4.8,95.2,0,89.2,0z M57.3,18.6c1.1,0.1,2.1,1.4,2.1,2.8c0,1.4-0.9,2.5-2.1,2.4c-1.2-0.1-2.1-1.3-2.1-2.8C55.2,19.5,56.1,18.4,57.3,18.6z M88.9,73.2L12,87.1V13.8l41.6,4.4c-0.4,0.7-0.6,1.6-0.6,2.6c0,1.5,0.5,2.8,1.3,3.8c-1.5,1.1-2.4,3.1-2.4,5.5c0,3.8,2.5,6.8,5.5,6.9c2.9,0.1,5.2-2.8,5.2-6.4c0-2.2-0.9-4.3-2.3-5.6c0.7-0.9,1.2-2.1,1.2-3.5c0-0.9-0.2-1.8-0.5-2.6c0,0,0,0,0,0l28.1,3V73.2z\"/>\n"
  "<path d=\"M84.5,33.9v-8l-15.7-1.3c2.3,2.4,4.1,5.4,5.3,8.8L84.5,33.9z\"/>\n"
  "</svg>";

const char s_copySvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-285 377 40 40\">\n"
  "<style type=\"text/css\">svg{cursor:pointer}path{fill:silver}</style>\n"
  "<path d=\"M-258,388h-4.2c-0.4-1.2-1.5-2-2.8-2s-2.4,0.8-2.8,2h-4.2c-1.1,0-2,0.9-2,2v16c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2v-16C-256,388.9-256.9,388-258,388L-258,388z M-265,388c0.6,0,1,0.4,1,1s-0.4,1-1,1s-1-0.4-1-1S-265.6,388-265,388L-265,388z M-258,406h-14v-16h2v3h10v-3h2V406L-258,406z\"/>\n"
  "</svg>";

const char s_refreshSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-309 393 40 40\">\n"
  "<style type=\"text/css\">svg{cursor:pointer}path{fill:silver}</style>\n"
  "<path d=\"M-280.4,413c-0.9,0-1.3,0.6-1.4,1.3c-0.5,2.3-2.7,5.9-7.1,5.9c-3.9,0-7.1-3.2-7.1-7.1s3.2-7.1,7.1-7.1c1.6,0,3.1,0.5,4.3,1.4h-1.4c-0.8,0-1.4,0.6-1.4,1.4s0.6,1.4,1.4,1.4h4.3c0.8,0,1.4-0.6,1.4-1.4v-4.3c0-0.8-0.6-1.4-1.4-1.4s-1.4,0.6-1.4,1.4v0.4c-1.6-1.1-3.6-1.8-5.7-1.8c-5.5,0-10,4.5-10,10s4.5,10,10,10c7.1,0,10-6.8,10-8.5C-279,413.5-279.8,413-280.4,413z\"/>\n"
  "</svg>";

const char s_showSvg[] = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
  "<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0\" y=\"0\" xml:space=\"preserve\" viewBox=\"-29 31 40 40\">\n"
	"<style type=\"text/css\">path{fill:silver}</style>\n"
  "<path d=\"M-9,44.7c-4.4,0-8.1,2.5-10,6.3c1.9,3.7,5.6,6.3,10,6.3s8.1-2.5,10-6.3C-0.9,47.2-4.6,44.7-9,44.7z M-4.1,48c1.2,0.7,2.2,1.8,2.9,2.9c-0.7,1.2-1.7,2.2-2.9,2.9c-1.5,0.9-3.2,1.4-4.9,1.4s-3.5-0.5-4.9-1.4c-1.2-0.7-2.2-1.8-2.9-2.9c0.7-1.2,1.7-2.2,2.9-2.9c0.1,0,0.2-0.1,0.2-0.1c-0.2,0.5-0.3,1.1-0.3,1.7c0,2.8,2.2,5,5,5s5-2.2,5-5c0-0.6-0.1-1.2-0.3-1.7C-4.2,47.9-4.1,48-4.1,48z M-9,49c0,1-0.8,1.9-1.9,1.9s-1.9-0.8-1.9-1.9s0.8-1.9,1.9-1.9S-9,47.9-9,49z\"/>\n"
  "</svg>";

c_page myPages[] = {
  // sample code
  { "/index.html", "text/html", s_configHtml, false },
  { "/config.css", "text/css", s_configCss, false },
  { "/config1.js", "application/javascript", s_config1Js, false },
  { "/config2.js", "application/javascript", s_config2Js, false },

  { "/rsa-utils/rsa.js", "application/javascript", rsa_js, false },
  { "/rsa-utils/rng.js", "application/javascript", rng_js, false },
  { "/rsa-utils/jsbn_1.js", "application/javascript", jsbn_1_js, false },
  { "/rsa-utils/jsbn_2.js", "application/javascript", jsbn_2_js, false },
  { "/rsa-utils/prng4.js", "application/javascript", prng4_js, false },

  { "/logo.svg", "image/svg+xml", s_logoSvg , true},
  { "/copy.svg", "image/svg+xml", s_copySvg, true},
  { "/refresh.svg", "image/svg+xml", s_refreshSvg, true },
  { "/show.svg", "image/svg+xml", s_showSvg, true },
  { nullptr }
};

void f_pageHandler(const char* url, ResponseCallback* cb, void* cbArg, Reader* o_request, Writer* o_response, void* reserved) {
    Serial.printlnf("handling page %s", url);

    if (strcmp(url, "/index") == 0) {
        Serial.println("sending redirect");
        Header h("Location: /index.html\r\n");
        cb(cbArg, 0, 301, "text/plain", &h);
        return;
    }
    else if (strcmp(url, "/load-config") == 0) {
      char s_buffer[MAXNAMESIZE + 250];
      c_config& o_config = c_config::f_getInstance();
      o_config.f_getJsonConfig(s_buffer);
      cb(cbArg, 0, 200, "application/json", nullptr);
      o_response->write(s_buffer);
      return;
    }
    else if (strcmp(url, "/save-config") == 0) {
      SetConfigCommand o_command = SetConfigCommand();
      cb(cbArg, 0, 200, "application/json", nullptr);
      o_command.execute(*o_request, *o_response);
      return;
    }

    int8_t idx = 0;
    for (;;idx++) {
        c_page& p = myPages[idx];
        if (!p.url) {
            idx = -1;
            break;
        }
        else if (strcmp(url, p.url) == 0) {
            break;
        }
    }

    if (idx == -1) {
      cb (cbArg, 0, 404, nullptr, nullptr);
    }
    else {

      const char* s_page = myPages[idx].data;
      int n_length = strlen(s_page);
      char s_header[100];
      sprintf(
        s_header,
        "Content-Length: %u\r\n",
        n_length
      );
      Header h(s_header);
      if (myPages[idx].force_type) {
        sprintf(
          s_header,
          "Content-Type: %s\r\n",
          myPages[idx].mime_type
        );
        Header h(s_header);
      }
      cb (cbArg, 0, 200, myPages[idx].mime_type, &h);
      o_response->write(s_page);
    }
}
